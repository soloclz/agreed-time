# Developer Guide

Welcome to the AgreedTime developer documentation. This guide covers the project architecture, code standards, and contribution workflows.

---

## 1. Architecture & Patterns

This project is built with **Astro** (Static Shell) and **React** (Interactive Islands).

### Core Concept: Astro Islands
We follow the "HTML First" philosophy. The page shell (`Layout`, `Header`, `Text`) is static HTML generated by Astro. Only interactive widgets (like the Form and Calendar) are hydrated as React components using `client:load`.

### File Structure
*   **`src/pages/`**: File-system routing. `new.astro` corresponds to `/new`.
*   **`src/components/`**: React components and Astro snippets.
    *   `CreateEventForm.tsx`: The main "Island" controller.
    *   `TimeSlotSelector.tsx`: The core calendar widget logic.
*   **`src/utils/`**: Pure helper functions (e.g., date manipulation using `date-fns`).

### Key Logic: TimeSlotSelector
*   **State**: Selected slots are stored as a `Set<string>` of **UTC ISO Strings** (`2025-12-05T09:00:00Z`).
*   **Layout**: Uses a specific "Sticky Column" layout where the time labels are in a separate `div` from the scrollable date grid.
*   **Mobile**: Implements custom "Long Press" logic for drag-selection on touch devices.
*   **Heatmap Mode (Planned)**: The `TimeSlotSelector` is designed to be reusable for heatmap visualization, accepting `heatmapData` and `totalParticipants` props to render color intensity instead of selectable states. This ensures consistency and reusability.

---

## 2. Code Style & Standards

### Tech Stack
*   **Framework**: Astro + React 19
*   **Styling**: Tailwind CSS
*   **Language**: TypeScript (Strict mode)
*   **Date Handling**: `date-fns` (Always use UTC for storage, Local for display)

### Best Practices
*   **Functional Components**: Use React Hooks (`useState`, `useMemo`, `useCallback`).
*   **Props Interface**: Always define a TypeScript interface for component props.
*   **Tailwind**: Use utility classes directly. For complex logic, use conditional strings (template literals).
*   **Accessibility**: Ensure all interactive elements have `role`, `aria-label`, and keyboard support (`onKeyDown`).

---

## 3. Git Commit Convention

We follow the **[Conventional Commits](https://www.conventionalcommits.org/)** specification.

### Format
`type(scope): subject`

### Types
*   `feat`: New feature
*   `fix`: Bug fix
*   `docs`: Documentation only
*   `style`: Formatting (whitespace, semi-colons)
*   `refactor`: Code change that neither fixes a bug nor adds a feature
*   `chore`: Build process, deps, or auxiliary tools

### Example
*   `feat(calendar): add sticky time column`
*   `fix(mobile): resolve long-press selection bug`

---

## 4. Development Workflow

1.  **Start Dev Server**: `npm run dev`
2.  **Build for Production**: `npm run build`
3.  **Preview Build**: `npm run preview`

---

## 5. Event Access and Management Strategy

This section outlines the planned approach for managing access to event pages, balancing ease-of-use with necessary security and privacy considerations, especially before a full user authentication system is in place.

### 5.1 User Flows & Page Roles

*   **Create Event Page (`/new`)**:
    *   Allows users (organizers) to define event details and availability.
    *   Upon successful creation, an event ID (`:id`) is generated.
*   **Guest Submission Page (`/event/:id`)**:
    *   Accessible via a public invitation link.
    *   Allows attendees to submit their available time slots and optional comments.
*   **Event Result Page (`/event/:id/result`)**:
    *   Displays aggregated availability, best time recommendations, and participant responses.
    *   **Core Vision**: To evolve into a heatmap visualization of time slot intersections. Initially, it will provide a list-based summary.

### 5.2 Access Control Mechanism (Hybrid Model)

To provide a balance between frictionless anonymous usage and future member-based management, a hybrid access control model will be implemented.

#### 5.2.1 Public Event ID (`:id`)
*   Generated for every event.
*   Used for public-facing links, primarily the Guest Submission Page (`/event/:id`).
*   The Event Result Page (`/event/:id/result`) may or may not be publicly accessible, depending on the organizer's privacy preference. Defaulting to publicly viewable results for ease of sharing is common, but private access will be supported via the management flows.

#### 5.2.2 `adminToken` (Long Secret String)
*   A unique, long, and unguessable token (e.g., UUID) generated upon event creation.
*   **Purpose**: Provides direct, secret-link-based access to event management features (e.g., `/event/:id/manage?token=adminToken`) without requiring a login. This is primarily for **anonymous organizers**.
*   **Best Practice**: This "Capability URL" design is a standard and effective pattern for frictionless access in stateless/anonymous applications (e.g., Doodle, Rallly).
*   **Security**: Relies on the secrecy of the token. Token must be sufficiently long and random. Transport via HTTPS is mandatory.
*   **Usage**: The organizer saves this link or its token to re-access full management capabilities. This link provides management rights.

#### 5.2.3 `secureCode` (Short, 6-Digit Code)
*   A short, memorable alphanumeric code generated upon event creation.
*   **Purpose**: Serves as a recovery or "claiming" mechanism, primarily for **anonymous organizers**.
*   **Validation**: `secureCode` alone is insufficient; it must be combined with the `eventId` for validation (`ID + Code` pattern).
*   **Best Practice**: `secureCode` should never be exposed in the URL. It must be entered manually into a dedicated input field or modal.
*   **Storage (Future Backend)**: When stored in a database, `secureCode` (like any password) must be salted and hashed.
*   **Usage**: If an organizer loses their `adminToken` link, they can use the `eventId` and `secureCode` to regain access to management features (e.g., via a "Lookup" page or directly on the event page).

### 5.3 User Experience Flows & Implementation Details

*   **Event Creation Success Screen (`/new` post-submit)**:
    *   Displays the public Guest Link (for participants to respond).
    *   Displays the Admin Link (containing the `adminToken`), masked from direct view with a "Copy Admin Link" button for enhanced security against shoulder-surfing. A clear warning against sharing this link is provided.
    *   Displays the `secureCode`, initially masked (e.g., `******`) with a toggle to reveal. The recovery instruction is context-driven, guiding users to use the code directly on their event page for admin access.
    *   A "Go to Event Results" button navigates to the `event/:id/result` page.

*   **Result Link Revelation**:
    *   The Result Link (`/event/:id/result`) is generally **not actively exposed on the event creation success screen** to avoid overwhelming the user or causing confusion about which link to share.
    *   **Recommended Revelation Points**:
        1.  **Admin/Manage Page (Future)**: The primary place for the organizer to retrieve and share the Result Link, especially for publicly shared results.
        2.  **Result Page Itself**: A "Share Results" button on the `event/:id/result` page itself allows anyone (organizer or participant) to copy the Result Link. This is a common and intuitive practice.

*   **Admin Link Invalid/Expired Handling (Graceful Degradation - Future Backend)**:
    *   If a user accesses `/event/:id/manage?token=invalid-token`, instead of showing an error, the system will redirect them to the public Result Page (`/event/:id/result`).
    *   A prominent banner message on the Result Page should then inform the user: *"The admin link you used is invalid or expired. You are viewing the public results instead."* This provides a user-friendly fallback.

*   **Frontend Organizer Identification (Cookie/LocalStorage - Immediate Future)**:
    *   To improve convenience for the organizer, upon successful event creation (or successful `adminToken`/`secureCode` validation), a flag (`agreed_time_admin_${eventId}`) containing the `adminToken` will be stored in the browser's LocalStorage or a secure Cookie.
    *   This allows the same browser to automatically identify as the event's organizer for that `eventId` in subsequent visits, providing management capabilities without needing to re-enter the token. This offers a "sticky session" for the owner on a specific browser.

### 5.4 Future Enhancements

*   **Member Integration**: Once a user authentication system is in place, if an event is created by a logged-in member, the `adminToken` and `secureCode` will still be generated but may not be explicitly shown to the user (as their account login provides management access). Members will manage events from a personalized dashboard.
*   **"Claim Event" Feature**: A dedicated interface for members to link existing events to their accounts using the `secureCode`.
*   **Backend API**: Implementation of actual API endpoints for event creation, response submission, and result retrieval, replacing current mock data.
*   **Heatmap Visualization**: Enhance the Result Page to graphically display availability intersections.
*   **Edit Participant Response**: Allow participants to modify their previously submitted time slots.
*   **Event Expiry/Deadline**: Option for organizers to set a deadline for submissions.
*   **Social Sharing Buttons**: Integrate direct share options for Guest Link and (public) Result Link.
*   **Email Reminders**: Option to send links/updates via email.

---

## 6. Frontend UI/UX Details

This section documents the visual and interactive design choices made during development.

### 6.1 Header and Brand Identity

*   **Fixed Header**: A responsive, fixed header (`Layout.astro`) is present across all pages for consistent navigation and branding.
*   **Logo Display**: The `agreed-time-logo.svg` is used as the primary brand identifier.
    *   **Header**: The icon is paired with the text "AgreedTime" (`<span class="font-sans font-bold text-ink">AgreedTime</span>`) to ensure clear brand visibility. The spacing between the icon and text (`gap-0`) is set for a tight, cohesive lockup.
    *   **Favicon**: The `agreed-time-logo.svg` itself is directly used as the favicon, ensuring brand consistency in browser tabs. The redundant `favicon.svg` file has been removed.
    *   **Homepage Hero**: The landing page's hero section prominently displays only the large graphic logo (`agreed-time-logo.svg`) without additional text, maintaining a minimalist and "airy" aesthetic.
*   **Brand Typography**: The primary brand typeface for text elements like "AgreedTime" is set to `font-sans` (Zen Kaku Gothic New) for a modern and digital-native feel, complementing the geometric icon. Serif fonts are used for general headings, and mono fonts for technical/time displays.

### 6.2 Visual Theme (Fujifilm-Inspired Palette)

The application's color palette is carefully crafted to evoke a Fujifilm-inspired aesthetic, characterized by cool, cyanic tones and subtle contrasts.

*   **`frontend/tailwind.config.mjs` Colors**:
    *   `paper`: `#F4F8FA` (Soft, low-saturation blue-grey for main background, reducing visual strain).
    *   `ink`: `#155E75` (Deep cyan-tinted grey for primary text, providing rich contrast).
    *   `film-accent`: `#0891B2` (Vibrant Cyan 600 for primary interactive elements, buttons, selected states).
    *   `film-accent-hover`: `#0E7490` (Darker Cyan 700 for hover states).
    *   `film-border`: `#d4e8ed` (Light, cool grey for borders, matching the logo's outer stroke).
    *   `film-light`: `#FFFFFF` (Pure white for elements like input backgrounds and card interiors, creating layered depth).
*   **Consistency**: All UI components, including `TimeSlotSelector` (selected slot color) and `EventResultView`, now automatically utilize this palette, ensuring a unified visual experience.

### 6.3 Event Result Page Enhancements

*   **Empty State Handling**: `EventResultView.tsx` now conditionally renders a user-friendly empty state when no responses have been submitted. This includes a clear message ("No responses yet!"), an illustrative icon, and a call to action. For admins, a "Go to Guest Link" button is provided.
*   **Share Results Button**: A prominent "Share Results" button is available on the Result Page, allowing any viewer to easily copy the current page's URL to their clipboard.
*   **Admin Action Buttons**: For identified event administrators (via LocalStorage token), "Finalize" and "Delete" action buttons are displayed. These are currently simulated with alerts for demonstration purposes.

---

## 7. Heatmap Visualization (Planned Implementation)

The `TimeSlotSelector` component will be extended to support a dedicated "heatmap" mode for the Result Page, providing a graphical overview of participant availability.

*   **Reusability**: `TimeSlotSelector` will be intelligently reused and extended rather than creating a separate component.
*   **Props Expansion**: New props will include `mode: 'select' | 'heatmap'`, `heatmapData: Record<string, HeatmapCellData>`, and `totalParticipants: number`.
*   **`HeatmapData` Structure**: A `HeatmapCellData` interface (`{ count: number; attendees: string[]; }`) will be used to store aggregated availability for each time slot. This pre-calculated data (done in the parent component like `EventResultView`) will ensure efficient rendering.
*   **Visual Representation**: In heatmap mode, `<td>` elements will display varying shades of `film-accent` (e.g., using `bg-film-accent/[opacity]`) based on the `count` of available participants relative to `totalParticipants`.
*   **Interaction**: In heatmap mode, selection interactions (click, drag, long-press) will be disabled. Hover tooltips will provide detailed information (e.g., "X people available").
*   **Logic Separation**: The `TimeSlotSelector` will focus solely on rendering; the `EventResultView` will handle the aggregation of raw responses into `heatmapData`.